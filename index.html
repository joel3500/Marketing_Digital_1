<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat avec les Responsables Marketing</title>

  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins|Sofia|Trirong|Audiowide">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins&effect=fire|neon|outline|emboss|shadow-multiple">

  <!-- Ton CSS -->
  <link rel="stylesheet" href="static/style.css">

  <!-- Socket.IO client -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>

  <h2> Les Responsables Marketing <br><br> GYMNASE INTELLIGENT A DOMICILE </h2>

  <!-- Bandeau image (ton CSS s’occupe du fond) -->
  <header class="header_avec_image"></header>

  <div class="grand_cadre_du_chat">
    <main class="container">
      <!-- poster_un_chat -->
      <div class="poster_un_chat">
        <!-- IMPORTANT : action absolue pour fallback sans JS -->
        <form id="chat-form" class="chat-form" action="https://marketing-chat.onrender.com/post" method="post">
          <div class="row">
            <label for="prenom">Prénom</label>
            <input type="text" id="prenom" name="prenom" placeholder="Alice" required>
          </div>
          <div class="row">
            <label for="filiaire">Filière</label>
            <input type="text" id="filiaire" name="filiaire" placeholder="Arts et Lettres" required>
          </div>
          <div class="row">
            <label for="commentaire">Commentaire</label>
            <textarea id="commentaire" name="commentaire" placeholder="Coool ! c'est super d'avoir de quoi interagir avec les responsables :)" required></textarea>
          </div>
          <button id="send-btn" type="submit">Envoyer</button>
          <span id="status" class="status" aria-live="polite"></span>
        </form>
      </div>

      <hr>

      <!-- le_chat -->
      <div class="le_chat" id="le_chat">
        <p class="empty">Aucun message pour le moment — lance la discussion !</p>
      </div>
    </main>
  </div>

  <script>
    // Ton backend Render
    const RENDER_BASE = "https://marketing-chat.onrender.com";

    // Connexion Socket.IO au backend Render
    const socket = io(RENDER_BASE, { transports: ["websocket", "polling"] });
    socket.on('connect', () => console.log('[SOCKET] connecté', socket.id));
    socket.on('connect_error', (e) => console.error('[SOCKET] erreur', e));
    
    # logguer la réponse du fetch pour vérifier le 200 :
    const res = await fetch(`${RENDER_BASE}/api/chat`, {...});
    console.log('POST /api/chat status', res.status);
    
    const form = document.getElementById('chat-form');
    const btn  = document.getElementById('send-btn');
    const st   = document.getElementById('status');
    const chat = document.getElementById('le_chat');

    // Reçoit les nouveaux messages (événement émis par ton serveur)
    socket.on('chat:new', (msg) => {
      const empty = chat.querySelector('.empty');
      if (empty) empty.remove();
      const line = document.createElement('div');
      line.className = 'chat-line';
      line.innerHTML = `<strong>${escapeHtml(msg.prenom)}</strong> ( <em>${escapeHtml(msg.filiaire)}</em> ) : ${escapeHtml(msg.commentaire)}`;
      chat.prepend(line);
    });

    // Envoi via l’API JSON de Render (sans rechargement)
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      btn.disabled = true;
      st.textContent = 'Envoi...';
      const payload = {
        prenom: document.getElementById('prenom').value.trim(),
        filiaire: document.getElementById('filiaire').value.trim(),
        commentaire: document.getElementById('commentaire').value.trim()
      };
      try {
        const res = await fetch(`${RENDER_BASE}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const data = await res.json().catch(()=>({error:'Erreur'}));
          throw new Error(data.error || ('HTTP ' + res.status));
        }
        form.reset();
        st.textContent = 'Envoyé ✔';
      } catch (err) {
        st.textContent = 'Erreur: ' + err.message;
      } finally {
        btn.disabled = false;
        setTimeout(()=> st.textContent = '', 2000);
      }
    });

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;').replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;').replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }
  </script>

  <footer>
    Projet réalisé par : Rashid, Mohamed et Dolorès, et Joel | 2MAR210 A2025 : Marketing Digital | UQAC | Automne 2025
  </footer>
</body>
</html>
